<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ImageConversionRestController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">image-converter-service</a> &gt; <a href="index.source.html" class="el_package">org.imageconverter.controller</a> &gt; <span class="el_source">ImageConversionRestController.java</span></div><h1>ImageConversionRestController.java</h1><pre class="source lang-java linenums">package org.imageconverter.controller;

import static java.util.stream.Collectors.joining;
import static org.apache.commons.lang3.StringUtils.EMPTY;
import static org.imageconverter.util.controllers.imageconverter.ImageConverterConst.REST_URL;
import static org.springframework.http.HttpHeaders.CONTENT_DISPOSITION;
import static org.springframework.http.HttpStatus.CREATED;
import static org.springframework.http.HttpStatus.NO_CONTENT;
import static org.springframework.http.HttpStatus.OK;
import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;
import static org.springframework.http.MediaType.MULTIPART_FORM_DATA_VALUE;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.imageconverter.application.ImageConversionService;
import org.imageconverter.domain.conversion.ExecutionType;
import org.imageconverter.domain.conversion.ImageConversion;
import org.imageconverter.util.controllers.imageconverter.ImageConversionPostResponse;
import org.imageconverter.util.controllers.imageconverter.ImageConversionResponse;
import org.imageconverter.util.controllers.imageconverter.ImageConverterRequest;
import org.imageconverter.util.controllers.imageconverter.ImageConverterRequestArea;
import org.imageconverter.util.controllers.imageconverter.ImageConverterRequestInterface;
import org.imageconverter.util.logging.Loggable;
import org.imageconverter.util.openapi.imageconverter.ImageConverterRestGetByIdOpenApi;
import org.imageconverter.util.openapi.imageconverter.ImageConverterRestGetOpenApi;
import org.imageconverter.util.openapi.imageconverter.ImageConverterRestPostAreaOpenApi;
import org.imageconverter.util.openapi.imageconverter.ImageConverterRestPostOpenApi;
import org.imageconverter.util.openapi.imagetype.ImageTypeRestDeleteOpenApi;
import org.springdoc.core.converters.models.PageableAsQueryParam;
import org.springframework.context.annotation.Description;
import org.springframework.core.io.InputStreamResource;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.data.web.PageableDefault;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RequestPart;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import com.turkraft.springfilter.boot.Filter;

import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;

/**
 * Image converter http rest.
 * 
 * @author Fernando Romulo da Silva
 */
@SecurityRequirement(name = &quot;BASIC&quot;)
@Tag( //
		name = &quot;Image Convert&quot;, //
		description = &quot;&quot;&quot;
				Image Convert API - If something went wrong, please put 'trace' (for all Http methods)
				at the end of the call to receive the stackStrace.
				Ex: http://127.0.0.1:8080/image-converter/rest/images/convert?trace=true
				     &quot;&quot;&quot; //
)
//
@Loggable
@RestController
@Description(&quot;Controller for image converstion API&quot;)
@RequestMapping(REST_URL)
public class ImageConversionRestController {

    private final ImageConversionService imageConversionService;

    /**
     * Default constructor.
     * 
     * @param imageConversionService The image convert service
     */
    ImageConversionRestController(final ImageConversionService imageConversionService) {
<span class="fc" id="L92">	super();</span>
<span class="fc" id="L93">	this.imageConversionService = imageConversionService;</span>
<span class="fc" id="L94">    }</span>

    /**
     * Get a conversion already done.
     * 
     * @param id The image conversion's id
     * @return A {@link ImageConversionResponse} object
     * @exception ElementNotFoundException if a element with id not found
     */
    @ImageConverterRestGetByIdOpenApi
    //
    @ResponseStatus(OK)
    @GetMapping(value = &quot;/{id:[\\d]*}&quot;, produces = APPLICATION_JSON_VALUE)
    public ImageConversionResponse getById( //
		    @Parameter(name = &quot;id&quot;, description = &quot;The image conversion id's&quot;, required = true, example = &quot;3&quot;) //
		    @PathVariable(name = &quot;id&quot;, required = true) //
		    final Long id) {

<span class="fc" id="L112">	return imageConversionService.findById(id);</span>
    }

    /**
     * Get conversions by filter.
     * 
     * @param filter A object {@link Specification} that specific the filter the search
     * @param page   A object {@link Pageable} that page the result
     * @return A {@link List} or a empty list
     */
    @PageableAsQueryParam
    @ImageConverterRestGetOpenApi
    //
    @ResponseStatus(OK)
    @GetMapping(produces = APPLICATION_JSON_VALUE)
    public Page&lt;ImageConversionResponse&gt; getByFilter( //
		    @Parameter(name = &quot;filter&quot;, description = &quot;Search's filter&quot;, required = true, example = &quot;?filter=fileName:'image.png'&quot;) //
		    @Filter //
		    final Specification&lt;ImageConversion&gt; filter, // 
		    //
		    @PageableDefault(value = 10, page = 0) //
		    final Pageable page) {

<span class="fc" id="L135">	return imageConversionService.findBySpecification(filter, page);</span>
    }

    /**
     * Convert a image file on text.
     * 
     * @param file The image to convert
     * @return A {@link ImageConversionResponse} object with response.
     */
    @ImageConverterRestPostOpenApi
    //
    @ResponseStatus(CREATED)
    @PostMapping(consumes = { MULTIPART_FORM_DATA_VALUE }, produces = APPLICATION_JSON_VALUE)
    public ImageConversionPostResponse convert( //
		    @Parameter(description = &quot;The Image to be uploaded&quot;, content = @Content(mediaType = MULTIPART_FORM_DATA_VALUE), required = true, example = &quot;image.bmp&quot;) //
		    @RequestPart(name = &quot;file&quot;, required = true) //
		    final MultipartFile file,
		    //
		    final HttpServletRequest request, final HttpServletResponse response) {

<span class="fc" id="L155">	final var bytes = extractBytes(file);</span>

<span class="fc" id="L157">	final var executionType = extractExecutionType(request);</span>

<span class="fc" id="L159">	final var result = imageConversionService.convert(new ImageConverterRequest(file.getOriginalFilename(), bytes, executionType));</span>

<span class="fc" id="L161">	response.addHeader(&quot;Location&quot;, REST_URL + &quot;/&quot; + result.id());</span>

<span class="fc" id="L163">	return new ImageConversionPostResponse(result.text());</span>
    }

    /**
     * Convert a image file with area on text.
     * 
     * @param file   The image to convert
     * @param xAxis  The image's x coordinate
     * @param yAxis  The image's y coordinate
     * @param width  The image's width in pixels
     * @param height The image's height in pixels
     * @return A {@link ImageConversionResponse} object with response.
     */
    @ImageConverterRestPostAreaOpenApi
    //
    @ResponseStatus(CREATED)
    @PostMapping(value = &quot;/area&quot;, consumes = { MULTIPART_FORM_DATA_VALUE }, produces = APPLICATION_JSON_VALUE)
    public ImageConversionPostResponse convertWithArea( //
		    @Parameter(description = &quot;The Image to be uploaded&quot;, content = @Content(mediaType = MULTIPART_FORM_DATA_VALUE), required = true, example = &quot;image.bmp&quot;) //
		    @RequestPart(name = &quot;file&quot;, required = true) //
		    final MultipartFile file, //
		    //
		    @Parameter(description = &quot;The vertical position&quot;, required = true, example = &quot;3&quot;) //
		    @RequestParam(required = true) //
		    final Integer xAxis, //
		    //
		    @Parameter(description = &quot;The horizontal position&quot;, required = true, example = &quot;4&quot;) //
		    @RequestParam(required = true) //
		    final Integer yAxis, //
		    //
		    @Parameter(description = &quot;The width size's area&quot;, required = true, example = &quot;56&quot;) //
		    @RequestParam(required = true) //
		    final Integer width, //
		    //
		    @Parameter(description = &quot;The height's size area &quot;, required = true, example = &quot;345&quot;) //
		    @RequestParam(required = true) //
		    final Integer height,
		    //
		    final HttpServletRequest request, final HttpServletResponse response) {

<span class="fc" id="L203">	final var executionType = extractExecutionType(request);</span>

<span class="fc" id="L205">	final byte[] bytes = extractBytes(file);</span>

<span class="fc" id="L207">	final var result = imageConversionService.convert(new ImageConverterRequestArea(file.getOriginalFilename(), bytes, executionType, xAxis, yAxis, width, height));</span>

<span class="fc" id="L209">	response.addHeader(&quot;Location&quot;, REST_URL + &quot;/&quot; + result.id());</span>

<span class="fc" id="L211">	return new ImageConversionPostResponse(result.text());</span>
    }

    /**
     * Convert multiple images file on text.
     * 
     * @param files The images' collection to convert
     * @return A list of {@link ImageConversionResponse} with each response.
     */
    @ImageConverterRestPostOpenApi
    //
    @ResponseStatus(CREATED)
    @PostMapping(value = &quot;/multiple&quot;, consumes = { MULTIPART_FORM_DATA_VALUE }, produces = APPLICATION_JSON_VALUE)
    public List&lt;ImageConversionPostResponse&gt; convert( //
		    @Parameter(description = &quot;The Images to be uploaded&quot;, content = @Content(mediaType = MULTIPART_FORM_DATA_VALUE), required = true, example = &quot;image1.bmp, image2.png&quot;) //
		    @RequestPart(name = &quot;files&quot;, required = true) //
		    final MultipartFile[] files, //
		    //
		    final HttpServletRequest request, //
		    final HttpServletResponse response) {

<span class="fc" id="L232">	final var executionType = extractExecutionType(request);</span>

<span class="fc" id="L234">	final var listRequest = new ArrayList&lt;ImageConverterRequestInterface&gt;();</span>

<span class="fc bfc" id="L236" title="All 2 branches covered.">	for (final var file : files) {</span>
<span class="fc" id="L237">	    listRequest.add(new ImageConverterRequest(file.getOriginalFilename(), extractBytes(file), executionType));</span>
	}

<span class="fc" id="L240">	final var result = imageConversionService.convert(listRequest);</span>

<span class="fc" id="L242">	response.addHeader(&quot;Location&quot;, result.stream().map(rst -&gt; REST_URL + &quot;/&quot; + rst.id()).collect(joining(&quot;;&quot;)));</span>

<span class="fc" id="L244">	return result.stream().map(rst -&gt; new ImageConversionPostResponse(rst.text())).toList();</span>
    }

    /**
     * Delete a image conversion.
     * 
     * @param id The conversion id
     */
    @ImageTypeRestDeleteOpenApi
    //
    @ResponseStatus(NO_CONTENT)
    @DeleteMapping(&quot;/{id:[\\d]*}&quot;)
    public void delete( //
		    //
		    @Parameter(description = &quot;The conversion id's&quot;, example = &quot;1000&quot;) //
		    @PathVariable(name = &quot;id&quot;, required = true) //
		    final Long id) {

<span class="fc" id="L262">	imageConversionService.deleteImageConversion(id);</span>
<span class="fc" id="L263">    }</span>
    
    
    /**
     * Create a CSV file using filter.
     * 
     * @param filter A object {@link Specification} that specific the filter the search
     * @return A Csv file
     */
    @ResponseStatus(OK)
    @GetMapping(value = &quot;/export&quot;, produces = &quot;txt/csv&quot;)
    public ResponseEntity&lt;InputStreamResource&gt; downloadImageConversionCsv( //		    
		    @Parameter(name = &quot;filter&quot;, description = &quot;Search's filter&quot;, required = true, example = &quot;?filter=fileName:'image.png'&quot;) //
		    @Filter //
		    final Specification&lt;ImageConversion&gt; filter ) {
	
<span class="fc" id="L279">	final var bytes = imageConversionService.findBySpecificationToCsv(filter);</span>
	
<span class="fc" id="L281">	final var body = new InputStreamResource(new ByteArrayInputStream(bytes));</span>
	
<span class="fc" id="L283">	return ResponseEntity.ok()</span>
<span class="fc" id="L284">			.header(CONTENT_DISPOSITION, &quot;attachment; filename=convertions.csv&quot;)</span>
<span class="fc" id="L285">			.contentType(MediaType.parseMediaType(&quot;txt/csv&quot;))</span>
<span class="fc" id="L286">			.body(body);</span>
    }
    

    private byte[] extractBytes(final MultipartFile file) {
	byte[] bytes;
	try {
<span class="fc" id="L293">	    bytes = file.getBytes();</span>
<span class="pc" id="L294">	} catch (final IOException e) {</span>
<span class="nc" id="L295">	    bytes = new byte[0];</span>
	}
<span class="fc" id="L297">	return bytes;</span>
    }

    private ExecutionType extractExecutionType(final HttpServletRequest request) {
<span class="fc" id="L301">	final var executionTypeHeader = Optional.ofNullable(request.getHeader(&quot;Execution-Type&quot;)).orElse(EMPTY);</span>

<span class="fc" id="L303">	return ExecutionType.from(executionTypeHeader);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>