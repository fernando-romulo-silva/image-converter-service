<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SecurityConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">image-converter-service</a> &gt; <a href="index.source.html" class="el_package">org.imageconverter.config.security</a> &gt; <span class="el_source">SecurityConfig.java</span></div><h1>SecurityConfig.java</h1><pre class="source lang-java linenums">package org.imageconverter.config.security;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.factory.PasswordEncoderFactories;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.web.csrf.CookieCsrfTokenRepository;
import org.springframework.security.web.csrf.CsrfTokenRepository;
import org.springframework.security.web.csrf.HttpSessionCsrfTokenRepository;
import org.springframework.security.web.firewall.HttpFirewall;
import org.springframework.security.web.firewall.StrictHttpFirewall;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ResponseBody;

// https://freecontent.manning.com/five-awkward-things-about-spring-security-that-actually-make-sense/

/**
 * Project security's config.
 * 
 * @author Fernando Romulo da Silva
 */
@Configuration
public class SecurityConfig {

    private final String applicationUser;

    private final String applicationPassword;

    /**
     * Default constructor.
     * 
     * @param applicationUser     Default application user login
     * @param applicationPassword Default application user password
     */
    SecurityConfig( //
		    @Value(&quot;${application.user_login}&quot;) //
		    final String applicationUser, //
		    //
		    @Value(&quot;${application.user_password}&quot;) //
		    final String applicationPassword) {
<span class="fc" id="L45">	super();</span>
<span class="fc" id="L46">	this.applicationUser = applicationUser;</span>
<span class="fc" id="L47">	this.applicationPassword = applicationPassword;</span>
<span class="fc" id="L48">    }</span>

    /**
     * Create a configured filter.
     * 
     * @return a {@link HttpFirewall} configured
     */
    @Bean
    HttpFirewall allowUrlEncodedSlashHttpFirewall() {
<span class="fc" id="L57">	final var firewall = new StrictHttpFirewall();</span>
<span class="fc" id="L58">	firewall.setAllowUrlEncodedSlash(true);</span>
<span class="fc" id="L59">	firewall.setAllowSemicolon(true);</span>
<span class="fc" id="L60">	return firewall;</span>
    }

    // https://www.baeldung.com/csrf-thymeleaf-with-spring-security
    /**
     * Create a session csrf token repository.
     * 
     * @return a {@link CsrfTokenRepository} configured
     */
    @Bean
    CsrfTokenRepository httpSessionCsrfTokenRepository() {
	// repo.setParameterName(&quot;_csrf&quot;);
	// repo.setHeaderName(&quot;X-CSRF-TOKEN&quot;);
<span class="fc" id="L73">	return new HttpSessionCsrfTokenRepository();</span>

    }

    /**
     * Create a cookie csrf token repository.
     * 
     * @return a {@link CsrfTokenRepository} configured
     */
    @Bean
    CsrfTokenRepository cookieCsrfTokenRepository() {
        // X-XSRF-TOKEN
	// repo.setHeaderName(&quot;X-XSRF-TOKEN&quot;);
<span class="fc" id="L86">        return CookieCsrfTokenRepository.withHttpOnlyFalse();	</span>
    }

    /**
     * Create a user recorer.
     * 
     * @return a {@link UserDetailsService} configured
     */
    @Bean
    UserDetailsService userDetailsService() {

<span class="fc" id="L97">	final var encoder = PasswordEncoderFactories.createDelegatingPasswordEncoder();</span>

<span class="fc" id="L99">	final var manager = new InMemoryUserDetailsManager();</span>

<span class="fc" id="L101">	final var adminUser = User//</span>
<span class="fc" id="L102">			.withUsername(applicationUser) //</span>
<span class="fc" id="L103">			.password(encoder.encode(applicationPassword)) //</span>
<span class="fc" id="L104">			.roles(&quot;USER&quot;, &quot;ADMIN&quot;) //</span>
<span class="fc" id="L105">			.build();</span>

<span class="fc" id="L107">	manager.createUser(adminUser);</span>

<span class="fc" id="L109">	return manager;</span>
    }

//    @Bean
//    public PasswordEncoder encoder(){
//        return new BCryptPasswordEncoder();
//    }

    /**
     * Fix the Favicon problem.
     * 
     * @author Fernando Romulo da Silva
     */
    @Controller
<span class="fc" id="L123">    public static class FaviconController {</span>

	@GetMapping(&quot;favicon.ico&quot;)
	@ResponseBody
	void returnNoFavicon() {
	    // just to fix favicon.ico problem
<span class="nc" id="L129">	}</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>